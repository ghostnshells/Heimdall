import React, { useMemo } from 'react';
import {
    ResponsiveContainer,
    AreaChart,
    Area,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
} from 'recharts';
import { format, eachDayOfInterval, eachHourOfInterval, parseISO } from 'date-fns';
import { getDateRange } from '../../services/vulnerabilityService';
import './VulnerabilityChart.css';

const CustomTooltip = ({ active, payload, label }) => {
    if (!active || !payload?.length) return null;

    const data = payload[0]?.payload;
    return (
        <div className="chart-tooltip">
            <div className="chart-tooltip-date">{data?.fullDate || label}</div>
            <div className="chart-tooltip-row total">
                <span className="chart-tooltip-dot" style={{ background: '#6366f1' }} />
                <span>Total</span>
                <span className="chart-tooltip-value">{data?.total || 0}</span>
            </div>
            <div className="chart-tooltip-row critical">
                <span className="chart-tooltip-dot" style={{ background: '#ef4444' }} />
                <span>Critical</span>
                <span className="chart-tooltip-value">{data?.critical || 0}</span>
            </div>
            <div className="chart-tooltip-row high">
                <span className="chart-tooltip-dot" style={{ background: '#f97316' }} />
                <span>High</span>
                <span className="chart-tooltip-value">{data?.high || 0}</span>
            </div>
            <div className="chart-tooltip-row medium">
                <span className="chart-tooltip-dot" style={{ background: '#eab308' }} />
                <span>Medium</span>
                <span className="chart-tooltip-value">{data?.medium || 0}</span>
            </div>
            <div className="chart-tooltip-row low">
                <span className="chart-tooltip-dot" style={{ background: '#3b82f6' }} />
                <span>Low</span>
                <span className="chart-tooltip-value">{data?.low || 0}</span>
            </div>
        </div>
    );
};

const VulnerabilityChart = ({ vulnerabilities, timeRange }) => {
    const chartData = useMemo(() => {
        if (!vulnerabilities?.all?.length) return [];

        const { startDate, endDate } = getDateRange(timeRange);
        const isHourly = timeRange === '24h';

        // Generate all intervals in the range
        const intervals = isHourly
            ? eachHourOfInterval({ start: startDate, end: endDate })
            : eachDayOfInterval({ start: startDate, end: endDate });

        // Build a map: key -> { total, critical, high, medium, low }
        const bucketMap = new Map();
        intervals.forEach(date => {
            const key = isHourly
                ? format(date, 'yyyy-MM-dd HH:00')
                : format(date, 'yyyy-MM-dd');
            bucketMap.set(key, { total: 0, critical: 0, high: 0, medium: 0, low: 0 });
        });

        // Bucket each vulnerability by its published date
        vulnerabilities.all.forEach(vuln => {
            if (!vuln.published) return;
            const pubDate = new Date(vuln.published);
            const key = isHourly
                ? format(pubDate, 'yyyy-MM-dd HH:00')
                : format(pubDate, 'yyyy-MM-dd');

            const bucket = bucketMap.get(key);
            if (!bucket) return;

            bucket.total++;
            const sev = vuln.severity?.toUpperCase();
            if (sev === 'CRITICAL') bucket.critical++;
            else if (sev === 'HIGH') bucket.high++;
            else if (sev === 'MEDIUM') bucket.medium++;
            else if (sev === 'LOW') bucket.low++;
        });

        // Convert to array for Recharts
        return intervals.map(date => {
            const key = isHourly
                ? format(date, 'yyyy-MM-dd HH:00')
                : format(date, 'yyyy-MM-dd');
            const bucket = bucketMap.get(key);

            let displayLabel;
            let fullDate;
            if (isHourly) {
                displayLabel = format(date, 'ha');
                fullDate = format(date, 'MMM d, yyyy h:mm a');
            } else if (timeRange === '7d') {
                displayLabel = format(date, 'EEE, MMM d');
                fullDate = format(date, 'EEEE, MMM d, yyyy');
            } else {
                displayLabel = format(date, 'MMM d');
                fullDate = format(date, 'EEEE, MMM d, yyyy');
            }

            return {
                date: displayLabel,
                fullDate,
                ...bucket,
            };
        });
    }, [vulnerabilities, timeRange]);

    // Determine tick interval based on data length
    const tickInterval = useMemo(() => {
        const len = chartData.length;
        if (len <= 8) return 0;
        if (len <= 14) return 1;
        if (len <= 31) return 3;
        if (len <= 60) return 6;
        return Math.floor(len / 10);
    }, [chartData.length]);

    if (!chartData.length) {
        return (
            <div className="vuln-chart-container">
                <div className="vuln-chart-header">
                    <h3 className="vuln-chart-title">Vulnerabilities Over Time</h3>
                </div>
                <div className="vuln-chart-empty">No vulnerability data available for this time range.</div>
            </div>
        );
    }

    return (
        <div className="vuln-chart-container">
            <div className="vuln-chart-header">
                <h3 className="vuln-chart-title">Vulnerabilities Over Time</h3>
                <div className="vuln-chart-legend">
                    <span className="legend-item"><span className="legend-dot" style={{ background: '#ef4444' }} />Critical</span>
                    <span className="legend-item"><span className="legend-dot" style={{ background: '#f97316' }} />High</span>
                    <span className="legend-item"><span className="legend-dot" style={{ background: '#eab308' }} />Medium</span>
                    <span className="legend-item"><span className="legend-dot" style={{ background: '#3b82f6' }} />Low</span>
                </div>
            </div>
            <div className="vuln-chart-body">
                <ResponsiveContainer width="100%" height={280}>
                    <AreaChart data={chartData} margin={{ top: 10, right: 10, left: -10, bottom: 0 }}>
                        <defs>
                            <linearGradient id="gradCritical" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#ef4444" stopOpacity={0.3} />
                                <stop offset="100%" stopColor="#ef4444" stopOpacity={0} />
                            </linearGradient>
                            <linearGradient id="gradHigh" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#f97316" stopOpacity={0.25} />
                                <stop offset="100%" stopColor="#f97316" stopOpacity={0} />
                            </linearGradient>
                            <linearGradient id="gradMedium" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#eab308" stopOpacity={0.2} />
                                <stop offset="100%" stopColor="#eab308" stopOpacity={0} />
                            </linearGradient>
                            <linearGradient id="gradLow" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor="#3b82f6" stopOpacity={0.2} />
                                <stop offset="100%" stopColor="#3b82f6" stopOpacity={0} />
                            </linearGradient>
                        </defs>
                        <CartesianGrid
                            strokeDasharray="3 3"
                            stroke="rgba(255,255,255,0.06)"
                            vertical={false}
                        />
                        <XAxis
                            dataKey="date"
                            tick={{ fill: '#71717a', fontSize: 11 }}
                            axisLine={{ stroke: 'rgba(255,255,255,0.08)' }}
                            tickLine={false}
                            interval={tickInterval}
                        />
                        <YAxis
                            tick={{ fill: '#71717a', fontSize: 11 }}
                            axisLine={false}
                            tickLine={false}
                            allowDecimals={false}
                        />
                        <Tooltip content={<CustomTooltip />} cursor={{ stroke: 'rgba(99,102,241,0.3)', strokeWidth: 1 }} />
                        <Area
                            type="monotone"
                            dataKey="critical"
                            stroke="#ef4444"
                            fill="url(#gradCritical)"
                            strokeWidth={2}
                            dot={false}
                            activeDot={{ r: 4, strokeWidth: 0, fill: '#ef4444' }}
                            stackId="1"
                        />
                        <Area
                            type="monotone"
                            dataKey="high"
                            stroke="#f97316"
                            fill="url(#gradHigh)"
                            strokeWidth={2}
                            dot={false}
                            activeDot={{ r: 4, strokeWidth: 0, fill: '#f97316' }}
                            stackId="1"
                        />
                        <Area
                            type="monotone"
                            dataKey="medium"
                            stroke="#eab308"
                            fill="url(#gradMedium)"
                            strokeWidth={2}
                            dot={false}
                            activeDot={{ r: 4, strokeWidth: 0, fill: '#eab308' }}
                            stackId="1"
                        />
                        <Area
                            type="monotone"
                            dataKey="low"
                            stroke="#3b82f6"
                            fill="url(#gradLow)"
                            strokeWidth={2}
                            dot={false}
                            activeDot={{ r: 4, strokeWidth: 0, fill: '#3b82f6' }}
                            stackId="1"
                        />
                    </AreaChart>
                </ResponsiveContainer>
            </div>
        </div>
    );
};

export default VulnerabilityChart;
