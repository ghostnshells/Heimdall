name: Refresh Vulnerability Cache

# Run every hour at the top of the hour
# GitHub Actions is free for public repos and has generous limits for private repos
on:
  schedule:
    # Runs at minute 0 of every hour (same as "0 * * * *")
    - cron: '0 * * * *'

  # Allow manual triggering from GitHub Actions UI
  workflow_dispatch:

jobs:
  refresh-cache:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger cache refresh
        run: |
          echo "Triggering cache refresh for batch processing..."

          # The cron endpoint processes 4 assets per run
          # We need 7 runs to process all 26 assets
          # This workflow runs hourly, so it will take 7 hours for a full refresh

          # Using bypass mode (ALLOW_CRON_BYPASS=true must be set in Vercel)
          curl -X GET "${{ secrets.VERCEL_PRODUCTION_URL }}/api/cron/refresh" \
            -H "Content-Type: application/json" \
            --fail \
            --show-error \
            --silent \
            --output response.json

          echo "Response:"
          cat response.json | jq '.' || cat response.json

      - name: Check response
        run: |
          # Verify the response indicates success
          if grep -q '"success":true' response.json; then
            echo "✓ Cache refresh successful"
          else
            echo "✗ Cache refresh may have failed"
            cat response.json
            exit 1
          fi
