name: Full Cache Refresh (Manual)

# This workflow can ONLY be triggered manually from GitHub Actions UI
# Use this to populate the entire cache immediately (all 7 batches)
on:
  workflow_dispatch:

jobs:
  full-refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Run all cache refresh batches
        run: |
          echo "Starting full cache refresh (7 batches)..."
          echo "This will take about 20-30 seconds"
          echo ""

          BATCH=0
          while [ $BATCH -lt 7 ]; do
            BATCH=$((BATCH + 1))
            echo "‚è≥ Triggering batch $BATCH/7..."

            if [ -n "${{ secrets.CRON_SECRET }}" ]; then
              RESPONSE=$(curl -s -X GET "${{ secrets.VERCEL_PRODUCTION_URL }}/api/cron/refresh" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
                -H "Content-Type: application/json")
            else
              RESPONSE=$(curl -s -X GET "${{ secrets.VERCEL_PRODUCTION_URL }}/api/cron/refresh" \
                -H "Content-Type: application/json")
            fi

            echo "   Response: $RESPONSE"

            # Check for success
            if echo "$RESPONSE" | grep -q '"success":true'; then
              echo "   ‚úì Batch $BATCH successful"
            else
              echo "   ‚úó Batch $BATCH failed"
              echo "$RESPONSE"
            fi

            # Wait 2 seconds between requests
            if [ $BATCH -lt 7 ]; then
              echo "   Waiting 2 seconds..."
              sleep 2
            fi
            echo ""
          done

          echo "‚úÖ Full cache refresh complete!"
          echo "üîç Check your app - vulnerabilities should now be visible."
